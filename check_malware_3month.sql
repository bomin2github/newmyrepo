select ThreatName,viewviruslog.name,nodename,
   sum(
     case substring(cast(viewviruslog.recordtime as varchar(10)) from 1 for 7)
       when substring(cast(now()-'1month'::interval as varchar(10)) from 1 for 7) then 1
       else 0 end) onemonthago,
   sum(
     case substring(cast(viewviruslog.recordtime as varchar(10)) from 1 for 7)
       when substring(cast(now()-'2month'::interval as varchar(10)) from 1 for 7) then 1
       else 0 end) twomonthago,
   sum(
     case substring(cast(viewviruslog.recordtime as varchar(10)) from 1 for 7)
       when substring(cast(now()-'3month'::interval as varchar(10)) from 1 for 7) then 1
       else 0 end) threemonthago
from viewviruslog
where substring(cast(recordtime as varchar(10)) from 1 for 7)
   <> substring(cast(now() as varchar(10)) from 1 for 7)
   and
   substring(cast(recordtime as varchar(10)) from 1 for 7)
   >= substring(cast(now()-'3month'::interval as varchar(10)) from 1 for 7)
group by ThreatName,viewviruslog.name,nodename
order by ThreatName,viewviruslog.name,nodename
